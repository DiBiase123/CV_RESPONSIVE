<?php
$conn = mysqli_connect("127.0.0.1:3306","xaraton","micio1917!","onlinebot");
if($conn)
    {
        $user_messages = mysqli_real_escape_string($conn, $_POST['messageValue']);
        $query = "SELECT * FROM chatbot WHERE messages LIKE '%$user_messages%'";
        $makeQuery = mysqli_query($conn, $query);

        $query4 = "SELECT DATE_FORMAT(messages_date, '%H:%I') AS Extrat_H FROM chatbot_msg ORDER BY id_msg DESC LIMIT 1";
        $conn->query($query4);
        $makeQuery4 = mysqli_query($conn, $query4);
        $result4= mysqli_fetch_assoc($makeQuery4);
        if(mysqli_num_rows($makeQuery) > 0) 
        {
            $result = mysqli_fetch_assoc($makeQuery);
            echo $result['response'] . 
            '<p class="text-end text-dark m-0" style="font-size: smaller;">' .
            date("H:i").
            '</p>';
        }
        else 
        {
            //// MIEE RICHIESTA
            $query3 = "INSERT INTO chatbot_msg (messages, messages_date , messages_time)  VALUES ('$user_messages',  now() , CURTIME())";
            $conn->query($query3);
 
            $query2 = 
            "SELECT 
            CASE messages REGEXP '^[A-Za-z0-9._%\-+!#$&/=?^|~]+@[A-Za-z0-9.-]+[.][A-Za-z]+$'
            WHEN '1' THEN 'E-mail'
            ELSE 'not_validMail' 
            END AS 'response_mail',
            CASE  regexp_like(messages,'^[[:digit:]]{10}$')  
            WHEN '1' THEN 'Phone'
            ELSE 'not_validPhone' 
            END AS 'response_phone' 
            FROM chatbot_msg 
            ORDER BY id_msg DESC LIMIT 1";       
            $conn->query($query2);
            $makeQuery2 = mysqli_query($conn, $query2);
             if(mysqli_num_rows($makeQuery2) > 0) 
            {
                $result2 = mysqli_fetch_assoc($makeQuery2);
                if (($result2['response_mail'] === "E-mail") AND ($result2['response_phone'] === "not_validPhone" )) 
                {
                    echo $result2['response_mail'] . " Enregistré. <br/>  Merci de nous avoir contacté ." ;
                //     '<br><p class="text-end text-dark m-0" style="font-size: smaller;">' . 
                //     $result4['Extrat_H'] . 
                //     '&ensp; <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-check2 text-secondary p-0 m-0 mt-0 check1" viewBox="0 0 16 16" >' .
                //     '<path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>' .
                //     '</svg>'.
                //     '</p>';
                }
                if (($result2['response_mail'] === "not_validMail") AND ($result2['response_phone'] === "Phone" )) 
                {
                
                    echo $result2['response_phone'] . " Enregistré. <br/>  Merci de nous avoir contacté" ;
                     
                } 
                if (($result2['response_mail'] === "not_validMail") AND ($result2['response_phone'] === "not_validPhone" )) 
                {
                
                    echo "Votre message a été enregistré." ;
                    echo "</br> Veuillez nous fournir votre adresse e-mail ou téléphone pour vous recontacter." ;

                } 

               
            }
        }
     }
    // else 
    // {
    //     // If connection fails to establish, echo an error message
    //     echo "Connection failed" . mysqli_connect_errno();
    // }
    $url = 'https://api.green-api.com/waInstance7103891637/sendMessage/7df2f423428d4ef283c1a340a8c1f8acce8b63079da3448aab';

//chatId is the number to send the message to (@c.us for private chats, @g.us for group chats)
$data = array(
    'chatId' => '33769233561@c.us',
    'message' => $user_messages
);

$options = array(
    'http' => array(
        'header' => "Content-Type: application/json\r\n",
        'method' => 'POST',
        'content' => json_encode($data)
    )
);

$context = stream_context_create($options);

$response = file_get_contents($url, false, $context);

// echo $response;


?>